"""\nHeartbeat Manager - Periodic proactive check-ins.\n\nUnlike cron jobs that run exact tasks at specific times,\nheartbeats batch periodic checks into a single turn and share\nthe main session's context.\n"""\n\nimport asyncio\nimport json\nimport logging\nfrom dataclasses import dataclass\nfrom datetime import datetime, time\nfrom pathlib import Path\nfrom typing import Any, Callable, Coroutine, Optional\n\nlogger = logging.getLogger(__name__)\n\n\n@dataclass\nclass HeartbeatConfig:\n    """Configuration for heartbeat behavior."""\n    interval_minutes: int = 30\n    active_hours_start: int = 8\n    active_hours_end: int = 22\n    enabled: bool = True\n    \n    def is_active_now(self) -> bool:\n        """Check if we're in active hours."""\n        if not self.enabled:\n            return False\n        current_hour = datetime.now().hour\n        return self.active_hours_start <= current_hour < self.active_hours_end\n\n\nclass HeartbeatManager:\n    """\n    Manages proactive heartbeat check-ins.\n    \n    Heartbeats are periodic checks that:\n    - Run during active hours only\n    - Batch multiple checks into a single turn\n    - Share the main session's context\n    - Are configured via HEARTBEAT.md file\n    """\n\n    def __init__(\n        self,\n        workspace_dir: Optional[str] = None,\n        callback: Optional[Callable[[str], Coroutine[Any, Any, None]]] = None,\n    ):\n        self.workspace_dir = Path(workspace_dir or "~/.ii-telegram-agent/workspace").expanduser()\n        self.heartbeat_file = self.workspace_dir / "HEARTBEAT.md"\n        self.config_file = self.workspace_dir / "heartbeat_config.json"\n        self.callback = callback\n        self.config = HeartbeatConfig()\n        self._running = False\n        self._task: Optional[asyncio.Task] = None\n        self._last_heartbeat: Optional[datetime] = None\n        \n        self._ensure_files()\n        self._load_config()\n\n    def _ensure_files(self):\n        """Ensure heartbeat files exist."""\n        self.workspace_dir.mkdir(parents=True, exist_ok=True)\n        \n        if not self.heartbeat_file.exists():\n            default_content = """# Heartbeat Checklist\n\nThings to check during each heartbeat. The agent will process these items\nand take action if needed.\n\n## Quick Checks\n- [ ] Check for any urgent emails\n- [ ] Review calendar for upcoming events in next 2 hours\n- [ ] Check for pending reminders\n\n## Proactive Actions\n- [ ] If user has been idle for 8+ hours during active time, send a brief check-in\n- [ ] If there are important news in user's interest areas, prepare a summary\n\n## System Health\n- [ ] Monitor system resources if any alerts are configured\n\n---\n*Configure heartbeat timing in heartbeat_config.json*\n"""\n            self.heartbeat_file.write_text(default_content)\n            logger.info(f"Created heartbeat file at {self.heartbeat_file}")\n\n    def _load_config(self):\n        """Load heartbeat configuration."""\n        if self.config_file.exists():\n            try:\n                data = json.loads(self.config_file.read_text())\n                self.config = HeartbeatConfig(\n                    interval_minutes=data.get("interval_minutes", 30),\n                    active_hours_start=data.get("active_hours_start", 8),\n                    active_hours_end=data.get("active_hours_end", 22),\n                    enabled=data.get("enabled", True),\n                )\n            except Exception as e:\n                logger.error(f"Error loading heartbeat config: {e}")\n        else:\n            self._save_config()\n\n    def _save_config(self):\n        """Save heartbeat configuration."""\n        try:\n            data = {\n                "interval_minutes": self.config.interval_minutes,\n                "active_hours_start": self.config.active_hours_start,\n                "active_hours_end": self.config.active_hours_end,\n                "enabled": self.config.enabled,\n            }\n            self.config_file.write_text(json.dumps(data, indent=2))\n        except Exception as e:\n            logger.error(f"Error saving heartbeat config: {e}")\n\n    def get_checklist(self) -> str:\n        """Get the current heartbeat checklist."""\n        try:\n            return self.heartbeat_file.read_text()\n        except Exception as e:\n            logger.error(f"Error reading heartbeat file: {e}")\n            return ""\n\n    def update_checklist(self, content: str):\n        """Update the heartbeat checklist."""\n        try:\n            self.heartbeat_file.write_text(content)\n            logger.info("Updated heartbeat checklist")\n        except Exception as e:\n            logger.error(f"Error updating heartbeat file: {e}")\n\n    def configure(\n        self,\n        interval_minutes: Optional[int] = None,\n        active_hours_start: Optional[int] = None,\n        active_hours_end: Optional[int] = None,\n        enabled: Optional[bool] = None,\n    ):\n        """Update heartbeat configuration."""\n        if interval_minutes is not None:\n            self.config.interval_minutes = interval_minutes\n        if active_hours_start is not None:\n            self.config.active_hours_start = active_hours_start\n        if active_hours_end is not None:\n            self.config.active_hours_end = active_hours_end\n        if enabled is not None:\n            self.config.enabled = enabled\n        \n        self._save_config()\n        logger.info(f"Updated heartbeat config: every {self.config.interval_minutes}m, "\n                   f"active {self.config.active_hours_start}:00-{self.config.active_hours_end}:00")\n\n    def should_beat(self) -> bool:\n        """Check if a heartbeat should occur now."""\n        if not self.config.enabled:\n            return False\n        \n        if not self.config.is_active_now():\n            return False\n        \n        if self._last_heartbeat is None:\n            return True\n        \n        minutes_since_last = (datetime.now() - self._last_heartbeat).total_seconds() / 60\n        return minutes_since_last >= self.config.interval_minutes\n\n    def get_heartbeat_prompt(self) -> str:\n        """Generate the prompt for a heartbeat check."""\n        checklist = self.get_checklist()\n        now = datetime.now()\n        \n        prompt = f"""## Heartbeat Check - {now.strftime('%Y-%m-%d %H:%M')}\n\nYou're performing a periodic heartbeat check. Review the checklist below and take any necessary actions.\nOnly send a message to the user if there's something important or actionable.\n\n{checklist}\n\nRemember:\n- Be concise if you do send a message\n- Don't message just to say "all clear" unless specifically asked\n- Prioritize urgent items\n- Update any status items if needed\n"""\n        return prompt\n\n    async def _run_loop(self):\n        """Main heartbeat loop."""\n        while self._running:\n            try:\n                if self.should_beat():\n                    logger.info("Running heartbeat check")\n                    \n                    if self.callback:\n                        prompt = self.get_heartbeat_prompt()\n                        try:\n                            await self.callback(prompt)\n                        except Exception as e:\n                            logger.error(f"Error in heartbeat callback: {e}")\n                    \n                    self._last_heartbeat = datetime.now()\n                \n                await asyncio.sleep(60)\n                \n            except asyncio.CancelledError:\n                break\n            except Exception as e:\n                logger.error(f"Heartbeat error: {e}")\n                await asyncio.sleep(60)\n\n    def start(self):\n        """Start the heartbeat manager."""\n        if self._running:\n            return\n        \n        self._running = True\n        self._task = asyncio.create_task(self._run_loop())\n        logger.info(f"Heartbeat manager started (every {self.config.interval_minutes}m)")\n\n    def stop(self):\n        """Stop the heartbeat manager."""\n        self._running = False\n        if self._task:\n            self._task.cancel()\n        logger.info("Heartbeat manager stopped")\n\n    def get_status(self) -> dict:\n        """Get current heartbeat status."""\n        return {\n            "enabled": self.config.enabled,\n            "running": self._running,\n            "interval_minutes": self.config.interval_minutes,\n            "active_hours": f"{self.config.active_hours_start}:00-{self.config.active_hours_end}:00",\n            "is_active_now": self.config.is_active_now(),\n            "last_heartbeat": self._last_heartbeat.isoformat() if self._last_heartbeat else None,\n        }